## Codebase Patterns
- C++20, CMake 3.25+, macOS + Linux. OBJCXX enabled conditionally via `enable_language(OBJCXX)` inside `if(APPLE)`
- VST3 SDK fetched via FetchContent (v3.7.12_build_20)
- cpp-mcp library target name is `mcp` (not `cpp_mcp`)
- All source in source/, namespace VST3MCPWrapper
- COM-style interfaces (addRef/release) — use IPtr<> for safe ref counting
- Audio thread uses try_lock (never blocks) for parameter queue drain
- `MainThreadDispatcher` abstracts dispatch_async (macOS) / worker thread (Linux) for MCP load/unload
- State format: magic "VMCW" + version uint32 + pathLen uint32 + path + hosted state
- Build: cmake -B build -DCMAKE_BUILD_TYPE=Debug && cmake --build build --target VST3MCPWrapper
- Test target: cmake --build build --target VST3MCPWrapper_Tests
- Configure with tests: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=ON
- MCP handler logic extracted into `source/mcp_param_handlers.h` and `source/mcp_plugin_handlers.h` — testable inline functions separate from Controller
- Plugin management handlers are pure response-formatting functions (no VST3 mock dependencies) — pass strings/vectors as inputs
- Test target links against `mcp` library and includes `${cpp_mcp_SOURCE_DIR}/include` + `${cpp_mcp_SOURCE_DIR}/common` for `mcp::json` (which is `nlohmann::ordered_json`)
- `mcp::json` is defined in `mcp_message.h` as `using json = nlohmann::ordered_json` — include `mcp_message.h` for minimal JSON access
- Run tests: ctest --test-dir build --output-on-failure
- Google Test v1.14.0 via FetchContent in tests/CMakeLists.txt
- Test target links: sdk, sdk_hosting, GTest::gtest, GTest::gtest_main, GTest::gmock
- Use `fillTChar()` helper pattern to populate `TChar[]` buffers from `char16_t` literals in tests
- Use `ResizableMemoryIBStream` (header-only from `public.sdk/source/vst/utility/memoryibstream.h`) for test IBStream — supports read/write/seek/rewind
- State format read/write extracted into `writeStateHeader()`/`readStateHeader()` in `stateformat.h` — test these directly instead of going through Processor
- HostedPluginModule is a singleton — tests sharing it must drain the param queue in SetUp/TearDown to avoid cross-test contamination
- VST3 mock interfaces in `tests/mocks/mock_vst3.h` — MockComponent, MockAudioProcessor, MockEditController, MockMessage, MockAttributeList with working ref counting and queryInterface
- Mock ref counting: starts at 1, addRef increments, release decrements (no self-delete — test owns the object)
- `FUnknownPrivate::iidEqual()` for comparing TUIDs in queryInterface implementations
- `${CMAKE_CURRENT_SOURCE_DIR}` added to test include dirs for `mocks/` subdirectory access
- `friend class ProcessorTestAccess;` in processor.h for testing private state — define accessor class in VST3MCPWrapper namespace in test files
- Stack-allocated mocks with IPtr: always clear the IPtr before the mock goes out of scope to avoid use-after-destroy
- Processor can be instantiated with `new Processor()` + `initialize(nullptr)` for testing; call `terminate()` + `release()` in TearDown
- `ParameterChanges` from sdk_hosting is a stack-local in process() — verify parameter data inside mock's process lambda, never after the call returns (use-after-free)
- `ProcessorTestAccess` can be extended per test file with extra accessors (setProcessorReady, setHostedActive, etc.)
- Platform-specific code pattern: header with templates + `postImpl()` declaration, .mm/.cpp files for platform implementations. Use `if(APPLE)...else()` in CMake for platform source files
- `MainThreadDispatcher` owns the alive flag and dispatch logic — MCP handlers use `dispatcher.dispatch<R>(func, shutdownValue)` instead of raw dispatch_async + promise/future
- Platform-specific views: `wrapperview.mm` (macOS, NSView drop zone) / `wrapperview_linux.cpp` (no-op stub). Same `wrapperview.h` header used on both platforms
- Gate `#include <os/log.h>` and `os_log` calls behind `#ifdef __APPLE__`; use `fprintf(stderr, ...)` on Linux
- On Linux, add `module_linux.cpp` + `linuxmain.cpp` from VST3 SDK in `else()` CMake branches

- On Linux, `SMTG_ENABLE_VSTGUI_SUPPORT OFF` must be set (not just `SMTG_ADD_VSTGUI OFF`) to prevent VSTGUI from requiring X11 dev headers
- On Linux, `SMTG_ENABLE_VST3_PLUGIN_EXAMPLES OFF` and `SMTG_ENABLE_VST3_HOSTING_EXAMPLES OFF` needed alongside `SMTG_ADD_VST3_PLUGINS_SAMPLES OFF` etc.
- On Linux, the `mcp` static library must have `POSITION_INDEPENDENT_CODE ON` since VST3 plugins are .so shared objects (set via `set_target_properties` after `FetchContent_MakeAvailable`)
- GCC requires explicit `#include <optional>` — Clang/macOS may find it transitively but GCC does not
- Linux VST3 bundle layout: `build/VST3/Debug/VST3MCPWrapper.vst3/Contents/x86_64-linux/VST3MCPWrapper.so`
- Test suite is fully platform-independent — all 118 tests pass identically on macOS (Clang) and Linux (GCC) with no platform gating needed

---

# Ralph Progress Log
Started: new PRD — Linux Platform Support
---

## 2026-02-22 - US-001
- Built plugin and test targets on Linux (Ubuntu 24.04, GCC 13.3.0, x86_64)
- Files changed:
  - `CMakeLists.txt` — Added `SMTG_ENABLE_VSTGUI_SUPPORT OFF`, `SMTG_ENABLE_VST3_PLUGIN_EXAMPLES OFF`, `SMTG_ENABLE_VST3_HOSTING_EXAMPLES OFF`, and `POSITION_INDEPENDENT_CODE ON` for `mcp` target on Linux
  - `source/hostedplugin.h` — Added missing `#include <optional>` (GCC requires it explicitly)
- **Learnings for future iterations:**
  - VST3 SDK v3.7.12 uses `SMTG_ENABLE_VSTGUI_SUPPORT` (new name) not just `SMTG_ADD_VSTGUI` (old name) — both must be set OFF to fully disable VSTGUI
  - Linux builds produce a shared object (.so), so all static libs linked into the plugin need `-fPIC` — set `POSITION_INDEPENDENT_CODE ON` on the `mcp` target
  - GCC is stricter about transitive includes — always include `<optional>`, `<functional>`, etc. explicitly in headers that use them
  - cmake 3.31.4 installed to `~/.local/bin` via binary tarball (no sudo needed)
  - Build output on Linux: `build/VST3/Debug/VST3MCPWrapper.vst3/Contents/x86_64-linux/VST3MCPWrapper.so`
---

## 2026-02-22 - US-002
- Ran all 118 tests on Linux — all passed with zero failures, zero warnings
- No code changes needed — the test suite was already platform-independent
- Verified with: `ctest --test-dir build --output-on-failure` (0.59s total)
- Also verified no compiler warnings in source/ or tests/ files during build
- **Learnings for future iterations:**
  - The test suite is fully platform-independent between macOS and Linux — TChar handling, ResizableMemoryIBStream, mock ref counting, and state format all work identically on both platforms
  - GCC and Clang produce the same behavior for all 118 tests — no platform-specific test gating was needed
  - The `fillTChar()` helper and `char16_t` literal approach for TChar buffers works correctly on Linux (where TChar is char16_t, same as macOS)
---
