## Codebase Patterns
- C++20, CMake 3.25+, macOS + Linux. OBJCXX enabled conditionally via `enable_language(OBJCXX)` inside `if(APPLE)`
- VST3 SDK fetched via FetchContent (v3.7.12_build_20)
- cpp-mcp library target name is `mcp` (not `cpp_mcp`)
- All source in source/, namespace VST3MCPWrapper
- COM-style interfaces (addRef/release) — use IPtr<> for safe ref counting
- Audio thread uses try_lock (never blocks) for parameter queue drain
- `MainThreadDispatcher` abstracts dispatch_async (macOS) / worker thread (Linux) for MCP load/unload
- State format: magic "VMCW" + version uint32 + pathLen uint32 + path + hosted state
- Build: cmake -B build -DCMAKE_BUILD_TYPE=Debug && cmake --build build --target VST3MCPWrapper
- Test target: cmake --build build --target VST3MCPWrapper_Tests
- Configure with tests: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=ON
- MCP handler logic extracted into `source/mcp_param_handlers.h` and `source/mcp_plugin_handlers.h` — testable inline functions separate from Controller
- Plugin management handlers are pure response-formatting functions (no VST3 mock dependencies) — pass strings/vectors as inputs
- Test target links against `mcp` library and includes `${cpp_mcp_SOURCE_DIR}/include` + `${cpp_mcp_SOURCE_DIR}/common` for `mcp::json` (which is `nlohmann::ordered_json`)
- `mcp::json` is defined in `mcp_message.h` as `using json = nlohmann::ordered_json` — include `mcp_message.h` for minimal JSON access
- Run tests: ctest --test-dir build --output-on-failure
- Google Test v1.14.0 via FetchContent in tests/CMakeLists.txt
- Test target links: sdk, sdk_hosting, GTest::gtest, GTest::gtest_main, GTest::gmock
- Use `fillTChar()` helper pattern to populate `TChar[]` buffers from `char16_t` literals in tests
- Use `ResizableMemoryIBStream` (header-only from `public.sdk/source/vst/utility/memoryibstream.h`) for test IBStream — supports read/write/seek/rewind
- State format read/write extracted into `writeStateHeader()`/`readStateHeader()` in `stateformat.h` — test these directly instead of going through Processor
- HostedPluginModule is a singleton — tests sharing it must drain the param queue in SetUp/TearDown to avoid cross-test contamination
- VST3 mock interfaces in `tests/mocks/mock_vst3.h` — MockComponent, MockAudioProcessor, MockEditController, MockMessage, MockAttributeList with working ref counting and queryInterface
- Mock ref counting: starts at 1, addRef increments, release decrements (no self-delete — test owns the object)
- `FUnknownPrivate::iidEqual()` for comparing TUIDs in queryInterface implementations
- `${CMAKE_CURRENT_SOURCE_DIR}` added to test include dirs for `mocks/` subdirectory access
- `friend class ProcessorTestAccess;` in processor.h for testing private state — define accessor class in VST3MCPWrapper namespace in test files
- Stack-allocated mocks with IPtr: always clear the IPtr before the mock goes out of scope to avoid use-after-destroy
- Processor can be instantiated with `new Processor()` + `initialize(nullptr)` for testing; call `terminate()` + `release()` in TearDown
- `ParameterChanges` from sdk_hosting is a stack-local in process() — verify parameter data inside mock's process lambda, never after the call returns (use-after-free)
- `ProcessorTestAccess` can be extended per test file with extra accessors (setProcessorReady, setHostedActive, etc.)
- Platform-specific code pattern: header with templates + `postImpl()` declaration, .mm/.cpp files for platform implementations. Use `if(APPLE)...else()` in CMake for platform source files
- `MainThreadDispatcher` owns the alive flag and dispatch logic — MCP handlers use `dispatcher.dispatch<R>(func, shutdownValue)` instead of raw dispatch_async + promise/future
- Platform-specific views: `wrapperview.mm` (macOS, NSView drop zone) / `wrapperview_linux.cpp` (no-op stub). Same `wrapperview.h` header used on both platforms
- MCP server constructor: `mcp::server(conf)` where `conf` is `mcp::server::configuration{host, port, name, version}` — no `(host, port)` shorthand in our version
- MCP `sse_client` constructor takes a URL string: `mcp::sse_client("http://127.0.0.1:8771")` — NOT `(host, port)` args
- MCP tool handler return value goes into `tool_result["content"]` — return just the content array (e.g., `json::array({{{"type","text"},{"text","..."}}})`), NOT the full `{content, isError}` envelope
- MCP server `start(false)` = non-blocking (returns immediately), `start(true)` = blocking (run in a thread). Use `start(false)` for tests
- Linux VST3 scan paths (SDK module_linux.cpp): $HOME/.vst3/, /usr/lib/vst3/, /usr/local/lib/vst3/, /proc/self/exe/../vst3/
- Gate `#include <os/log.h>` and `os_log` calls behind `#ifdef __APPLE__`; use `fprintf(stderr, ...)` on Linux
- On Linux, add `module_linux.cpp` + `linuxmain.cpp` from VST3 SDK in `else()` CMake branches

- On Linux, `SMTG_ENABLE_VSTGUI_SUPPORT OFF` must be set (not just `SMTG_ADD_VSTGUI OFF`) to prevent VSTGUI from requiring X11 dev headers
- On Linux, `SMTG_ENABLE_VST3_PLUGIN_EXAMPLES OFF` and `SMTG_ENABLE_VST3_HOSTING_EXAMPLES OFF` needed alongside `SMTG_ADD_VST3_PLUGINS_SAMPLES OFF` etc.
- On Linux, the `mcp` static library must have `POSITION_INDEPENDENT_CODE ON` since VST3 plugins are .so shared objects (set via `set_target_properties` after `FetchContent_MakeAvailable`)
- GCC requires explicit `#include <optional>` — Clang/macOS may find it transitively but GCC does not
- Linux VST3 bundle layout: `build/VST3/Debug/VST3MCPWrapper.vst3/Contents/x86_64-linux/VST3MCPWrapper.so`
- Test suite is fully platform-independent — all 118 tests pass identically on macOS (Clang) and Linux (GCC) with no platform gating needed
- `$<TARGET_FILE:VST3MCPWrapper>` generator expression works in child-scope `add_test()` for referencing parent-scope targets
- Linux VST3 bundle also includes `Contents/Resources/moduleinfo.json` (auto-generated by SDK moduleinfotool)

---

# Ralph Progress Log
Started: new PRD — Linux Platform Support
---

## 2026-02-22 - US-001
- Built plugin and test targets on Linux (Ubuntu 24.04, GCC 13.3.0, x86_64)
- Files changed:
  - `CMakeLists.txt` — Added `SMTG_ENABLE_VSTGUI_SUPPORT OFF`, `SMTG_ENABLE_VST3_PLUGIN_EXAMPLES OFF`, `SMTG_ENABLE_VST3_HOSTING_EXAMPLES OFF`, and `POSITION_INDEPENDENT_CODE ON` for `mcp` target on Linux
  - `source/hostedplugin.h` — Added missing `#include <optional>` (GCC requires it explicitly)
- **Learnings for future iterations:**
  - VST3 SDK v3.7.12 uses `SMTG_ENABLE_VSTGUI_SUPPORT` (new name) not just `SMTG_ADD_VSTGUI` (old name) — both must be set OFF to fully disable VSTGUI
  - Linux builds produce a shared object (.so), so all static libs linked into the plugin need `-fPIC` — set `POSITION_INDEPENDENT_CODE ON` on the `mcp` target
  - GCC is stricter about transitive includes — always include `<optional>`, `<functional>`, etc. explicitly in headers that use them
  - cmake 3.31.4 installed to `~/.local/bin` via binary tarball (no sudo needed)
  - Build output on Linux: `build/VST3/Debug/VST3MCPWrapper.vst3/Contents/x86_64-linux/VST3MCPWrapper.so`
---

## 2026-02-22 - US-002
- Ran all 118 tests on Linux — all passed with zero failures, zero warnings
- No code changes needed — the test suite was already platform-independent
- Verified with: `ctest --test-dir build --output-on-failure` (0.59s total)
- Also verified no compiler warnings in source/ or tests/ files during build
- **Learnings for future iterations:**
  - The test suite is fully platform-independent between macOS and Linux — TChar handling, ResizableMemoryIBStream, mock ref counting, and state format all work identically on both platforms
  - GCC and Clang produce the same behavior for all 118 tests — no platform-specific test gating was needed
  - The `fillTChar()` helper and `char16_t` literal approach for TChar buffers works correctly on Linux (where TChar is char16_t, same as macOS)
---

## 2026-02-22 - US-003
- Validated Linux VST3 bundle layout: `VST3MCPWrapper.vst3/Contents/x86_64-linux/VST3MCPWrapper.so`
- Confirmed .so is a valid ELF 64-bit shared object (x86-64)
- Bundle also includes `Contents/Resources/moduleinfo.json` (generated by SDK's moduleinfotool)
- Added `cmake/validate_bundle_linux.cmake` CTest validation script — checks directory structure and ELF type
- Added `add_test()` in `tests/CMakeLists.txt` gated behind `if(NOT APPLE)` using `$<TARGET_FILE:VST3MCPWrapper>` generator expression
- Updated CLAUDE.md: platform-specific output paths, Linux symlink instructions, new cmake quirks, source file table entry
- Files changed:
  - `cmake/validate_bundle_linux.cmake` — New validation script
  - `tests/CMakeLists.txt` — Added bundle layout validation test
  - `CLAUDE.md` — Updated Build section, CMake Quirks, Source Files table
- All 119 tests pass (118 existing + 1 new bundle validation)
- **Learnings for future iterations:**
  - The VST3 SDK's `smtg_add_vst3plugin` macro handles Linux bundle layout correctly out of the box — no manual fixup needed
  - `$<TARGET_FILE:VST3MCPWrapper>` generator expression works in `add_test()` from `tests/CMakeLists.txt` (child scope can reference parent targets)
  - Linux VST3 bundles include `Contents/Resources/moduleinfo.json` auto-generated by SDK's moduleinfotool
  - The `file` command is available on Linux for ELF validation — cmake's `execute_process(COMMAND file ...)` works reliably
---

## 2026-02-22 - US-004
- Added `tests/test_dispatcher_linux.cpp` with 10 Google Test cases covering the Linux worker-thread dispatcher
- Tests cover: typed dispatch (int, string), void dispatch, sequential ordering, concurrent multi-thread dispatch, shutdown/isAlive, post-shutdown dispatch (returns shutdownValue), void post-shutdown dispatch (skips func), destructor join, repeated create/destroy (no thread leak)
- Files changed:
  - `tests/test_dispatcher_linux.cpp` — New test file (10 tests)
  - `tests/CMakeLists.txt` — Added test_dispatcher_linux.cpp to test target sources
- All 129 tests pass (119 existing + 10 new dispatcher tests)
- **Learnings for future iterations:**
  - The `MainThreadDispatcher` API is platform-independent (same header, same `dispatch<R>()` template) — tests work identically on macOS (GCD) and Linux (worker thread)
  - The Linux dispatcher's worker thread correctly drains remaining tasks before joining on shutdown — destructor is clean
  - `postImpl()` still accepts tasks after `shutdown()` but the `alive_` flag causes them to use `shutdownValue` — no deadlock risk
  - Concurrent `postImpl()` from multiple threads is safe (mutex-guarded queue)
---

## 2026-02-22 - US-005
- Added `tests/test_mcp_server_integration.cpp` with 6 Google Test cases for MCP server integration on Linux
- Tests cover: SSE endpoint accepts connections (raw httplib), tool call via MCP protocol (sse_client), server stops cleanly (< 3s), port released after stop (rebind succeeds), multiple sequential tool calls, ping response
- Files changed:
  - `tests/test_mcp_server_integration.cpp` — New integration test file (6 tests)
  - `tests/CMakeLists.txt` — Added test_mcp_server_integration.cpp to test target sources
- All 135 tests pass (129 existing + 6 new MCP server integration tests)
- **Learnings for future iterations:**
  - The cpp-mcp API differs between versions — our patched version uses `mcp::server(configuration)` constructor only (no `(host, port)` shorthand), and `sse_client` takes a URL string not `(host, port)` args
  - MCP tool handler return value is placed into `tool_result["content"]` by the server — return just the content array, not the full `{content, isError}` envelope (the server adds `isError: false` automatically)
  - `server->start(false)` is non-blocking (ideal for tests), `start(true)` blocks forever (use in a thread for production)
  - Server stop with an active sse_client connection takes ~10s due to SSE connection timeout — the `ServerStopsCleanly` test (no active clients) completes in ~0.4s
  - Port 18771 used for tests to avoid conflicts with the real plugin server on 8771
---

## 2026-02-22 - US-006
- Added `tests/test_plugin_scanning.cpp` with 6 Google Test cases for VST3 plugin scanning on Linux
- Tests cover: getModulePaths() no-crash, all returned paths have .vst3 extension, dummy bundle discovery in ~/.vst3/, handleListAvailablePlugins() empty list, handleListAvailablePlugins() with paths, handleListAvailablePlugins() with live scan
- Verified SDK module_linux.cpp scans 4 directories: $HOME/.vst3/, /usr/lib/vst3/, /usr/local/lib/vst3/, /proc/self/exe/../vst3/
- Dummy bundle test creates/cleans up a temporary .vst3 directory in ~/.vst3/ to verify discovery
- Files changed:
  - `tests/test_plugin_scanning.cpp` — New test file (6 tests)
  - `tests/CMakeLists.txt` — Added test_plugin_scanning.cpp to test target sources
- All 141 tests pass (135 existing + 6 new plugin scanning tests)
- **Learnings for future iterations:**
  - Linux SDK scans 4 directories for .vst3 bundles: $HOME/.vst3/, /usr/lib/vst3/, /usr/local/lib/vst3/, and application-relative (/proc/self/exe/../vst3/)
  - getModulePaths() gracefully handles missing directories (exceptions caught and silently ignored)
  - GCC requires explicit `#include <fstream>` for `std::ofstream` — it's incomplete type via `<iosfwd>` from gtest headers
  - handleListAvailablePlugins() returns `{content: [{type: "text", text: "<JSON array of paths>"}]}` — the text field is a stringified JSON array
---
