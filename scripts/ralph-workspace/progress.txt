# Ralph Progress Log
Started: Sun Feb 22 10:11:13 PM CET 2026
---

## Codebase Patterns
- Build and test: `cmake -B build -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=ON && cmake --build build --target VST3MCPWrapper_Tests && ctest --test-dir build --output-on-failure`
- `processorReady_` has exactly 3 call sites in processor.cpp: store true (loadHostedPlugin), store false (unloadHostedPlugin), load (process)
- CLAUDE.md Threading Safety section and ARCHITECTURE.md Stored State/Loading/Unloading sections both document memory ordering — keep them in sync
- grep the entire repo (not just source/) when auditing all uses of a symbol — tests and docs may also reference it
- All logging in source/ must use `WRAPPER_LOG` / `WRAPPER_LOG_ERROR` from `logging.h` — never raw `fprintf(stderr, ...)`
- WrapperPlugView ↔ Controller use COM observer pointers with manual back-pointer clearing in `terminate()` — `clearController()` breaks the cycle
- Test access helpers live in `tests/helpers/` — `ProcessorTestAccess` for Processor, `ControllerTestAccess` for Controller. Both use friend class declarations in the production header.

## 2026-02-22 - US-001
- Changed `processorReady_` from `memory_order_relaxed` to `memory_order_release` (stores) and `memory_order_acquire` (load in process())
- This ensures the audio thread sees fully-constructed hostedProcessor_/hostedComponent_ when the flag becomes true
- Other atomic bools (wrapperActive_, wrapperProcessing_, hostedActive_, hostedProcessing_) remain relaxed — they are independent flags, not publication guards
- Files changed: `source/processor.cpp`, `CLAUDE.md`, `ARCHITECTURE.md`
- **Learnings for future iterations:**
  - The test helper `processor_test_access.h` uses default memory order (seq_cst) for processorReady_ — no change needed there
  - ARCHITECTURE.md has pseudo-code loading/unloading sequences that mention processorReady_ — update those too when changing ordering semantics
---

## 2026-02-22 - US-002
- Replaced all raw `fprintf(stderr, ...)` calls in source files with `WRAPPER_LOG_ERROR(...)` macros
- Two call sites converted: `hostedplugin.cpp` (param queue overflow warning) and `processor.cpp` (null data pointer in notify)
- Added `#include "logging.h"` to both files
- Removed unused `#include <cstdio>` from processor.cpp (logging.h includes it internally)
- Files changed: `source/hostedplugin.cpp`, `source/processor.cpp`
- **Learnings for future iterations:**
  - Only controller.cpp previously included logging.h — any new logging in other source files needs the include added
  - The WRAPPER_LOG macros add the `[VST3MCPWrapper]` prefix automatically — don't include it in the format string
  - On macOS, WRAPPER_LOG routes to `os_log` (not stderr) — this is the intended behavior for unified logging
  - Test files may use their own fprintf — the story explicitly excludes test files from conversion
---

## 2026-02-22 - US-003
- Added surrogate pair handling to `utf16ToUtf8()` in hostedplugin.cpp
- Detects high surrogate (0xD800-0xDBFF) + low surrogate (0xDC00-0xDFFF) pairs and decodes to code points U+10000-U+10FFFF
- Encodes supplementary code points as 4-byte UTF-8 (0xF0 lead byte)
- Lone/orphaned surrogates are replaced with U+FFFD replacement character
- Added 8 new tests: musical note surrogate pair, mixed BMP+supplementary, lone high surrogate (mid-string and at end), lone low surrogate, boundary low (U+10000), boundary high (U+10FFFF), high surrogate at maxLen boundary
- Files changed: `source/hostedplugin.cpp`, `tests/test_utf16_conversion.cpp`
- **Learnings for future iterations:**
  - Surrogate check must come before the BMP encoding branches — surrogates fall in the 0xD800-0xDFFF range which would otherwise hit the 3-byte UTF-8 branch
  - When high surrogate is at maxLen boundary, the low surrogate is beyond maxLen — treat as lone surrogate
  - The `fillTChar` helper is not needed for surrogate tests — direct TChar array assignment works fine for values > 0x7F
---

## 2026-02-22 - US-004
- Extracted `kDispatchTimeout` constexpr (`std::chrono::seconds(5)`) — replaces two identical `seconds(5)` literals in load_plugin and unload_plugin handlers
- MCP server version now uses `FULL_VERSION_STR` from `version.h` instead of hardcoded `"0.1.0"`
- Added `#include "version.h"` to controller.cpp
- Verified `kMCPServerPort` is already the sole source of the `8771` literal in source files — no raw occurrences elsewhere
- Files changed: `source/controller.cpp`
- **Learnings for future iterations:**
  - `version.h` uses `#define FULL_VERSION_STR` (not a constexpr) — it's a preprocessor macro, safe to use in string initializers
  - `kMCPServerPort` and `kDispatchTimeout` are file-scope `static constexpr` in controller.cpp — not in a header, since they're only used in the MCPServer struct
---

## 2026-02-22 - US-005
- Moved `addRef()`, `release()`, and `queryInterface()` from platform-specific files into `wrapperview.h` as inline methods
- Removed 30 identical lines from both `wrapperview.mm` and `wrapperview_linux.cpp`
- The `refCount_` member was already declared in `wrapperview.h` (as `std::atomic<uint32>`)
- `inline` keyword on out-of-class definitions prevents ODR violations when header is included in multiple TUs
- Files changed: `source/wrapperview.h`, `source/wrapperview.mm`, `source/wrapperview_linux.cpp`
- **Learnings for future iterations:**
  - WrapperPlugView COM methods are platform-independent — only `isPlatformTypeSupported`, `attached`, `removed`, `onSize`, `switchToHostedView`, `switchToDropZone`, `removeDropZone`, and the constructor/destructor have platform-specific behavior
  - The header already included `pluginterfaces/base/funknown.h` which provides `FUnknownPrivate::iidEqual` — no extra includes needed
  - Both the plugin target and test target compile `wrapperview_linux.cpp`, so the inline methods are exercised in both link contexts
---

## 2026-02-22 - US-006
- Hardened WrapperPlugView destructor against controller lifetime by adding `clearController()` method and calling it from `Controller::terminate()`
- `Controller::terminate()` now clears the view's back-pointer (`activeView_->clearController()`) and sets `activeView_ = nullptr` before any teardown
- The existing `if (controller_)` null check in ~WrapperPlugView now correctly guards against both nullptr-from-constructor and controller-destroyed-first scenarios
- Added public `clearController()` method to WrapperPlugView in wrapperview.h (avoids friend dependency; makes intent explicit)
- Added comments documenting the lifetime relationship: Controller creates WrapperPlugView, DAW owns the view's lifetime via COM ref-counting, Controller may be destroyed first
- Files changed: `source/controller.cpp`, `source/controller.h`, `source/wrapperview.h`, `source/wrapperview.mm`, `source/wrapperview_linux.cpp`
- **Learnings for future iterations:**
  - `controller_` is private in WrapperPlugView — Controller is NOT a friend of WrapperPlugView (only the reverse: WrapperPlugView is a friend of Controller). Use a public method rather than direct member access.
  - The COM observer pointer pattern (raw pointer + manual back-pointer clearing in terminate) is standard for VST3 — no shared_ptr/weak_ptr needed
  - The DropZoneView (macOS) also has a raw controller pointer — same pattern applies if it outlives the controller
---

## 2026-02-22 - US-007
- Added 7 tests for `Controller::createView()` lifecycle in new `tests/test_controller_view.cpp`
- Fixed `createView()` to validate the `name` parameter against `ViewType::kEditor` — returns `nullptr` for unsupported view types and `nullptr` name (standard VST3 practice)
- Created `tests/helpers/controller_test_access.h` — `ControllerTestAccess` friend accessor for Controller private members (follows `ProcessorTestAccess` pattern)
- Tests cover: editor view creation, unsupported type rejection, null name rejection, IPlugView queryInterface, activeView_ tracking, second view replacing first, initial null state
- Files changed: `source/controller.cpp`, `source/controller.h`, `tests/test_controller_view.cpp` (new), `tests/helpers/controller_test_access.h` (new), `tests/CMakeLists.txt`, `CLAUDE.md`
- **Learnings for future iterations:**
  - `createView()` does not require `initialize()` — it only allocates a `WrapperPlugView` and sets `activeView_`
  - `FIDStringsEqual` from `pluginterfaces/base/fstrdefs.h` is the standard way to compare `FIDString` values — available through the SDK include chain
  - `ViewType::kEditor` is the only standard view type in VST3 — defined as `"editor"` in `ivsteditcontroller.h`
  - Follow the `ProcessorTestAccess` pattern for Controller test access: friend class declaration in header + test helper in `tests/helpers/`
---

## 2026-02-22 - US-008
- Added 7 tests for `Controller::setComponentState()` in new `tests/test_controller_state.cpp`
- Tests cover: null stream, empty path, nonexistent plugin path (load fails gracefully), corrupt magic, corrupt version, truncated stream, empty stream
- Extended `ControllerTestAccess` with `currentPluginPath()` and `hostedController()` accessors
- Key finding: `setComponentState()` returns `kResultOk` for ALL error cases (null stream, corrupt header, failed plugin load) — this is deliberate because header parsing failure is non-fatal on the controller side. The controller's setComponentState is for state synchronization, not validation.
- Files changed: `tests/test_controller_state.cpp` (new), `tests/helpers/controller_test_access.h`, `tests/CMakeLists.txt`, `CLAUDE.md`
- **Learnings for future iterations:**
  - `setComponentState()` does not require `initialize()` — it reads the state header and attempts `setupHostedController()` internally
  - Unlike `Processor::setState()` which returns `kResultFalse` for corrupt data, `Controller::setComponentState()` returns `kResultOk` for all parse failures — the controller treats state header errors as non-fatal
  - When a valid path is present but the plugin can't be loaded (e.g., nonexistent file), `currentPluginPath_` remains empty and `hostedController_` stays null — the controller falls through gracefully
  - `ControllerTestAccess` now mirrors `ProcessorTestAccess` style — thread-safe accessors using `lock_guard` on the mutex
---

## 2026-02-22 - US-009
- Fixed `Processor::setState()` to check the return value of `loadHostedPlugin()`
- On failure, logs a warning via `WRAPPER_LOG_ERROR` with the plugin path and skips `replayDawStateOntoHosted()`
- `setState()` still returns `kResultOk` — the wrapper state header was valid; the plugin just couldn't be loaded
- Added test `SetStateWithNonexistentPluginReturnsOkAndPassesThrough`: verifies `kResultOk` return, `processorReady_` is false, and `currentPluginPath_` is empty
- Files changed: `source/processor.cpp`, `tests/test_processor_state.cpp`
- **Learnings for future iterations:**
  - `loadHostedPlugin()` clears `currentPluginPath_` via `unloadHostedPlugin()` at the start, so after a failed load `currentPluginPath_` is always empty
  - The `notify("LoadPlugin")` path still calls `replayDawStateOntoHosted()` unconditionally after `loadHostedPlugin()` — this is harmless (hostedComponent_ is null, replay is a no-op) but could be tightened similarly
---

## 2026-02-22 - US-010
- Documented 4 previously-undocumented architectural decisions in CLAUDE.md and ARCHITECTURE.md
- `performEdit()` non-forwarding: explained that it deliberately does NOT forward to DAW's `componentHandler` because the wrapper exposes no parameters — added to Architecture section, Threading Safety, Known Limitations (CLAUDE.md) and Parameter Change Flow (ARCHITECTURE.md)
- Linux `MainThreadDispatcher` naming: clarified that on Linux tasks run on a dedicated worker thread, not the actual main thread — added to Threading Safety (CLAUDE.md) and Threading Rules (ARCHITECTURE.md)
- `activeView_` raw observer pointer: documented the COM observer pattern and `clearController()` teardown safety — added to Threading Safety (CLAUDE.md) and new Object Lifetime Notes section (ARCHITECTURE.md)
- Dual `currentPluginPath_`: documented why both Processor and Controller have independent copies on different threading domains — added to Threading Safety (CLAUDE.md) and Object Lifetime Notes (ARCHITECTURE.md)
- Updated `wrapperview.h` Source Files table entry to reflect inline COM methods and `clearController()` added in US-005/US-006
- Verified all Source Files table entries are accurate — no missing or stale entries
- Files changed: `CLAUDE.md`, `ARCHITECTURE.md`
- **Learnings for future iterations:**
  - Documentation-only stories don't require build changes but should still verify build+tests pass to confirm no accidental edits
  - When verifying Source Files tables, check actual file contents — descriptions may go stale after refactoring stories
  - The "No DAW automation recording" limitation is fundamental to the MVP architecture, not a bug — the wrapper has no exposed parameters for the DAW to automate
---
